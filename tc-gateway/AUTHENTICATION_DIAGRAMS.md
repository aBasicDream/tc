# TC å¾®æœåŠ¡è®¤è¯é“¾è·¯æµç¨‹å›¾

## ğŸ”„ ç”¨æˆ·ç™»å½•è®¤è¯å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant G as ç½‘å…³(tc-gateway)
    participant U as ç”¨æˆ·æœåŠ¡(tc-user-service)
    participant R as Redisç¼“å­˜
    participant D as MySQLæ•°æ®åº“

    Note over C,D: é˜¶æ®µ1: ç”¨æˆ·ç™»å½•æµç¨‹

    C->>G: 1. POST /api/auth/login<br/>{username, password}
    Note over G: æ£€æŸ¥å…¬å¼€è·¯å¾„ç™½åå•
    
    G->>U: 2. è½¬å‘ç™»å½•è¯·æ±‚
    Note over U: éªŒè¯ç”¨æˆ·åå¯†ç 
    
    U->>R: 3. æ£€æŸ¥ç™»å½•å¤±è´¥æ¬¡æ•°
    R-->>U: è¿”å›å¤±è´¥æ¬¡æ•°
    
    U->>D: 4. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    D-->>U: è¿”å›ç”¨æˆ·æ•°æ®
    
    Note over U: éªŒè¯å¯†ç å“ˆå¸Œ
    
    U->>U: 5. ç”ŸæˆJWT Token
    Note over U: åŒ…å«userId, username
    
    U->>R: 6. ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
    U->>D: 7. è®°å½•ç™»å½•æ—¥å¿—
    
    U->>G: 8. è¿”å›ç™»å½•å“åº”<br/>{accessToken, refreshToken, userInfo}
    G->>C: 9. è¿”å›æœ€ç»ˆå“åº”

    Note over C,D: é˜¶æ®µ2: è®¿é—®å—ä¿æŠ¤èµ„æºæµç¨‹

    C->>G: 10. GET /api/user/profile<br/>Authorization: Bearer token
    Note over G: æå–Bearer Token
    
    G->>R: 11. æ£€æŸ¥Tokené»‘åå•
    R-->>G: è¿”å›é»‘åå•çŠ¶æ€
    
    Note over G: éªŒè¯JWT Token<br/>è§£æç”¨æˆ·ä¿¡æ¯
    
    G->>G: 12. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´<br/>X-User-Id, X-Username
    
    G->>U: 13. è½¬å‘è¯·æ±‚åˆ°ç”¨æˆ·æœåŠ¡
    Note over U: ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯
    
    U->>U: 14. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    U->>G: 15. è¿”å›ä¸šåŠ¡æ•°æ®
    G->>C: 16. è¿”å›æœ€ç»ˆå“åº”

    Note over C,D: é˜¶æ®µ3: ç”¨æˆ·ç™»å‡ºæµç¨‹

    C->>G: 17. POST /api/auth/logout<br/>Authorization: Bearer token
    Note over G: æå–Token
    
    G->>R: 18. å°†TokenåŠ å…¥é»‘åå•
    Note over R: è®¾ç½®TTL: 24å°æ—¶
    
    G->>U: 19. è½¬å‘ç™»å‡ºè¯·æ±‚
    U->>D: 20. è®°å½•ç™»å‡ºæ—¥å¿—
    
    U->>G: 21. è¿”å›ç™»å‡ºæˆåŠŸ
    G->>C: 22. è¿”å›ç™»å‡ºå“åº”
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        C1[Webå‰ç«¯]
        C2[ç§»åŠ¨ç«¯]
        C3[ç¬¬ä¸‰æ–¹åº”ç”¨]
    end
    
    subgraph "ç½‘å…³å±‚"
        G1[TC Gateway<br/>ç»Ÿä¸€è®¤è¯å…¥å£]
        G2[JWTè®¤è¯è¿‡æ»¤å™¨]
        G3[è·¯ç”±è½¬å‘]
        G4[å¼‚å¸¸å¤„ç†]
    end
    
    subgraph "æœåŠ¡å±‚"
        S1[TC User Service<br/>ç”¨æˆ·æœåŠ¡]
        S2[TC Auth Service<br/>è®¤è¯æœåŠ¡]
        S3[TC Core Service<br/>æ ¸å¿ƒæœåŠ¡]
    end
    
    subgraph "æ•°æ®å±‚"
        R1[Redis<br/>ç¼“å­˜/ä¼šè¯]
        D1[MySQL<br/>ç”¨æˆ·æ•°æ®]
        D2[MySQL<br/>ä¸šåŠ¡æ•°æ®]
    end
    
    subgraph "å®‰å…¨å±‚"
        SEC1[JWT Token]
        SEC2[é»‘åå•æœºåˆ¶]
        SEC3[å¯†ç åŠ å¯†]
        SEC4[ç™»å½•ä¿æŠ¤]
    end
    
    C1 --> G1
    C2 --> G1
    C3 --> G1
    
    G1 --> G2
    G2 --> G3
    G3 --> G4
    
    G3 --> S1
    G3 --> S2
    G3 --> S3
    
    S1 --> R1
    S1 --> D1
    S2 --> R1
    S2 --> D1
    S3 --> D2
    
    G2 --> SEC1
    G2 --> SEC2
    S1 --> SEC3
    S1 --> SEC4
    
    style G1 fill:#e1f5fe
    style S1 fill:#f3e5f5
    style R1 fill:#fff3e0
    style D1 fill:#e8f5e8
```

## ğŸ” è®¤è¯çŠ¶æ€æµè½¬å›¾

```mermaid
stateDiagram-v2
    [*] --> æœªè®¤è¯: ç”¨æˆ·è®¿é—®
    
    æœªè®¤è¯ --> ç™»å½•ä¸­: æäº¤ç™»å½•ä¿¡æ¯
    ç™»å½•ä¸­ --> è®¤è¯æˆåŠŸ: ç”¨æˆ·åå¯†ç æ­£ç¡®
    ç™»å½•ä¸­ --> è®¤è¯å¤±è´¥: ç”¨æˆ·åå¯†ç é”™è¯¯
    è®¤è¯å¤±è´¥ --> ç™»å½•ä¸­: é‡æ–°ç™»å½•
    è®¤è¯å¤±è´¥ --> è´¦æˆ·é”å®š: å¤±è´¥æ¬¡æ•°è¶…é™
    
    è®¤è¯æˆåŠŸ --> å·²è®¤è¯: ç”ŸæˆJWT Token
    å·²è®¤è¯ --> è®¿é—®èµ„æº: æºå¸¦Tokenè¯·æ±‚
    è®¿é—®èµ„æº --> å·²è®¤è¯: TokenéªŒè¯é€šè¿‡
    è®¿é—®èµ„æº --> Tokenå¤±æ•ˆ: Tokenè¿‡æœŸ/æ— æ•ˆ
    
    Tokenå¤±æ•ˆ --> æœªè®¤è¯: é‡æ–°ç™»å½•
    å·²è®¤è¯ --> ç™»å‡º: ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
    ç™»å‡º --> æœªè®¤è¯: TokenåŠ å…¥é»‘åå•
    
    è´¦æˆ·é”å®š --> æœªè®¤è¯: é”å®šæ—¶é—´åˆ°æœŸ
```

## ğŸ“Š æ•°æ®æµå‘å›¾

```mermaid
flowchart LR
    subgraph "è¯·æ±‚æ•°æ®æµ"
        A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[ç½‘å…³æ¥æ”¶]
        B --> C[JWTéªŒè¯]
        C --> D[è·¯ç”±è½¬å‘]
        D --> E[æœåŠ¡å¤„ç†]
        E --> F[æ•°æ®æŸ¥è¯¢]
        F --> G[å“åº”è¿”å›]
    end
    
    subgraph "ç¼“å­˜æ•°æ®æµ"
        H[ç”¨æˆ·ä¿¡æ¯] --> I[Redisç¼“å­˜]
        I --> J[Tokené»‘åå•]
        J --> K[ç™»å½•è®¡æ•°]
    end
    
    subgraph "æŒä¹…åŒ–æ•°æ®æµ"
        L[ç”¨æˆ·æ•°æ®] --> M[MySQLå­˜å‚¨]
        M --> N[ç™»å½•æ—¥å¿—]
        N --> O[ä¸šåŠ¡æ•°æ®]
    end
    
    C --> I
    E --> M
    F --> H
```

## ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤æµç¨‹å›¾

```mermaid
flowchart TD
    A[è¯·æ±‚åˆ°è¾¾ç½‘å…³] --> B{æ£€æŸ¥å…¬å¼€è·¯å¾„}
    B -->|æ˜¯| C[ç›´æ¥è½¬å‘]
    B -->|å¦| D[æå–JWT Token]
    
    D --> E{Tokenæ ¼å¼æ­£ç¡®?}
    E -->|å¦| F[è¿”å›401æœªæˆæƒ]
    E -->|æ˜¯| G[æ£€æŸ¥é»‘åå•]
    
    G --> H{Tokenåœ¨é»‘åå•?}
    H -->|æ˜¯| F
    H -->|å¦| I[éªŒè¯Tokenç­¾å]
    
    I --> J{ç­¾åéªŒè¯é€šè¿‡?}
    J -->|å¦| F
    J -->|æ˜¯| K[æ£€æŸ¥Tokenè¿‡æœŸ]
    
    K --> L{Tokenæœªè¿‡æœŸ?}
    L -->|å¦| F
    L -->|æ˜¯| M[è§£æç”¨æˆ·ä¿¡æ¯]
    
    M --> N[æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´]
    N --> O[è½¬å‘åˆ°ä¸‹æ¸¸æœåŠ¡]
    
    style F fill:#ffebee
    style O fill:#e8f5e8
```

## ğŸ”„ é”™è¯¯å¤„ç†æµç¨‹å›¾

```mermaid
flowchart TD
    A[å¼‚å¸¸å‘ç”Ÿ] --> B{å¼‚å¸¸ç±»å‹}
    
    B -->|NotFoundException| C[æœåŠ¡ä¸å¯ç”¨<br/>è¿”å›404]
    B -->|ResponseStatusException| D[å“åº”çŠ¶æ€å¼‚å¸¸<br/>è¿”å›å¯¹åº”çŠ¶æ€ç ]
    B -->|JWTå¼‚å¸¸| E[Tokenæ— æ•ˆ<br/>è¿”å›401]
    B -->|å…¶ä»–å¼‚å¸¸| F[ç³»ç»Ÿå†…éƒ¨é”™è¯¯<br/>è¿”å›500]
    
    C --> G[ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼]
    D --> G
    E --> G
    F --> G
    
    G --> H[è®°å½•é”™è¯¯æ—¥å¿—]
    H --> I[è¿”å›é”™è¯¯å“åº”]
    
    style C fill:#fff3e0
    style D fill:#fff3e0
    style E fill:#ffebee
    style F fill:#ffebee
    style G fill:#e8f5e8
```

## ğŸ“ˆ æ€§èƒ½ç›‘æ§æµç¨‹å›¾

```mermaid
flowchart LR
    A[è¯·æ±‚å¼€å§‹] --> B[è®°å½•å¼€å§‹æ—¶é—´]
    B --> C[å¤„ç†è¯·æ±‚]
    C --> D[è®°å½•ç»“æŸæ—¶é—´]
    D --> E[è®¡ç®—å“åº”æ—¶é—´]
    E --> F[æ›´æ–°æ€§èƒ½æŒ‡æ ‡]
    F --> G[æ£€æŸ¥å‘Šè­¦é˜ˆå€¼]
    G --> H{è¶…è¿‡é˜ˆå€¼?}
    H -->|æ˜¯| I[å‘é€å‘Šè­¦]
    H -->|å¦| J[è®°å½•æŒ‡æ ‡]
    I --> J
    J --> K[å­˜å‚¨ç›‘æ§æ•°æ®]
    
    style I fill:#ffebee
    style J fill:#e8f5e8
```
