# TC 微服务认证链路架构图

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                TC 微服务认证链路架构                                │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   客户端     │    │   网关      │    │  用户服务    │    │   Redis     │    │   MySQL     │
│  (Client)   │    │ (Gateway)   │    │(UserService)│    │  (Cache)    │    │ (Database)  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │                   │
       │                   │                   │                   │                   │
       │ 1. 登录请求        │                   │                   │                   │
       │──────────────────▶│                   │                   │                   │
       │                   │                   │                   │                   │
       │                   │ 2. 转发登录请求    │                   │                   │
       │                   │──────────────────▶│                   │                   │
       │                   │                   │                   │                   │
       │                   │                   │ 3. 验证用户信息    │                   │
       │                   │                   │──────────────────▶│                   │
       │                   │                   │                   │                   │
       │                   │                   │ 4. 查询用户数据    │                   │
       │                   │                   │──────────────────────────────────────▶│
       │                   │                   │                   │                   │
       │                   │                   │ 5. 返回用户信息    │                   │
       │                   │                   │◀──────────────────────────────────────│
       │                   │                   │                   │                   │
       │                   │                   │ 6. 验证密码        │                   │
       │                   │                   │                   │                   │
       │                   │                   │ 7. 生成JWT Token  │                   │
       │                   │                   │                   │                   │
       │                   │                   │ 8. 缓存用户信息    │                   │
       │                   │                   │──────────────────▶│                   │
       │                   │                   │                   │                   │
       │                   │                   │ 9. 记录登录日志    │                   │
       │                   │                   │──────────────────────────────────────▶│
       │                   │                   │                   │                   │
       │                   │ 10. 返回Token     │                   │                   │
       │                   │◀──────────────────│                   │                   │
       │                   │                   │                   │                   │
       │ 11. 返回登录响应   │                   │                   │                   │
       │◀──────────────────│                   │                   │                   │
       │                   │                   │                   │                   │
       │                   │                   │                   │                   │
       │ 12. 访问受保护资源 │                   │                   │                   │
       │──────────────────▶│                   │                   │                   │
       │                   │                   │                   │                   │
       │                   │ 13. 验证JWT Token │                   │                   │
       │                   │                   │                   │                   │
       │                   │ 14. 检查黑名单     │                   │                   │
       │                   │──────────────────▶│                   │                   │
       │                   │                   │                   │                   │
       │                   │ 15. 解析用户信息   │                   │                   │
       │                   │                   │                   │                   │
       │                   │ 16. 转发请求       │                   │                   │
       │                   │──────────────────▶│                   │                   │
       │                   │                   │                   │                   │
       │                   │                   │ 17. 处理业务逻辑   │                   │
       │                   │                   │                   │                   │
       │                   │                   │ 18. 返回业务数据   │                   │
       │                   │                   │                   │                   │
       │                   │ 19. 返回响应       │                   │                   │
       │                   │◀──────────────────│                   │                   │
       │                   │                   │                   │                   │
       │ 20. 返回最终响应   │                   │                   │                   │
       │◀──────────────────│                   │                   │                   │
```

## 🔄 详细认证流程

### 阶段1: 用户登录流程

```
1. 客户端发送登录请求
   POST /api/auth/login
   {
     "username": "testuser",
     "password": "Test123456"
   }

2. 网关接收请求
   - 检查路径是否为公开路径 ✓
   - 转发到用户服务

3. 用户服务处理登录
   - 验证用户名/密码
   - 查询数据库获取用户信息
   - 验证密码哈希
   - 检查用户状态

4. 生成JWT Token
   - 创建Token包含用户ID和用户名
   - 设置过期时间
   - 使用密钥签名

5. 缓存和日志
   - 缓存用户信息到Redis
   - 记录登录日志到数据库
   - 清除登录失败次数

6. 返回登录响应
   {
     "accessToken": "eyJhbGciOiJIUzUxMiJ9...",
     "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
     "tokenType": "Bearer",
     "expiresIn": 86400,
     "userId": 1,
     "username": "testuser",
     "nickname": "测试用户",
     "avatar": null,
     "loginTime": "2025-09-17T10:30:00"
   }
```

### 阶段2: 访问受保护资源流程

```
1. 客户端发送请求
   GET /api/user/profile
   Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...

2. 网关认证验证
   - 提取Bearer Token
   - 检查Token是否在黑名单中
   - 验证Token签名和过期时间
   - 解析用户信息

3. 添加用户信息到请求头
   X-User-Id: 1
   X-Username: testuser
   X-Gateway: tc-gateway

4. 转发请求到用户服务
   GET /api/user/profile
   X-User-Id: 1
   X-Username: testuser
   X-Gateway: tc-gateway

5. 用户服务处理请求
   - 从请求头获取用户信息
   - 执行业务逻辑
   - 返回用户数据

6. 返回响应给客户端
   {
     "code": 200,
     "message": "success",
     "data": {
       "userId": 1,
       "username": "testuser",
       "nickname": "测试用户",
       "email": "test@example.com",
       "phone": "13800138001"
     }
   }
```

### 阶段3: 用户登出流程

```
1. 客户端发送登出请求
   POST /api/auth/logout
   Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...

2. 网关处理登出
   - 提取Token
   - 将Token加入黑名单
   - 设置过期时间

3. 用户服务处理登出
   - 清除用户会话信息
   - 记录登出日志

4. 返回登出响应
   {
     "code": 200,
     "message": "登出成功"
   }
```

## 🛡️ 安全机制

### 1. JWT Token安全
- ✅ 使用HS512算法签名
- ✅ 包含用户ID和用户名
- ✅ 设置过期时间(24小时)
- ✅ 支持Token刷新

### 2. 黑名单机制
- ✅ Redis存储失效Token
- ✅ 登出时加入黑名单
- ✅ 网关验证时检查黑名单

### 3. 密码安全
- ✅ SHA-256 + 盐值加密
- ✅ 随机盐值生成
- ✅ 密码强度验证

### 4. 登录保护
- ✅ 登录失败次数限制
- ✅ 账户锁定机制
- ✅ 分布式锁防暴力破解

## 📊 数据流向

### Redis缓存结构
```
blacklist:token123456789    → "username" (TTL: 24h)
user:info:1                 → UserInfo对象 (TTL: 1h)
login:count:username         → 失败次数 (TTL: 30min)
login:lock:username         → 锁定状态 (TTL: 30min)
```

### MySQL数据表
```
user_info                   → 用户基础信息
user_login_log              → 登录日志记录
user_fans                   → 用户粉丝统计
user_follow                 → 用户关注关系
user_settings               → 用户设置信息
```

## 🔧 技术实现细节

### 网关层 (tc-gateway)
- Spring Cloud Gateway
- JWT认证过滤器
- 全局异常处理
- CORS跨域配置
- Redis黑名单检查

### 用户服务层 (tc-user-service)
- Spring Boot + Spring Security
- MyBatis Plus数据访问
- JWT Token生成
- 密码加密验证
- 登录日志记录

### 数据层
- Redis: 缓存和会话管理
- MySQL: 持久化数据存储
- Redisson: 分布式锁

## 🚀 性能优化

### 1. 缓存策略
- 用户信息缓存(1小时)
- Token验证结果缓存
- 路由信息缓存

### 2. 连接池优化
- Redis连接池配置
- MySQL连接池配置
- HTTP连接池配置

### 3. 异步处理
- 响应式编程模型
- 非阻塞I/O操作
- 异步日志记录

## 📈 监控指标

### 1. 认证指标
- 登录成功率
- Token验证成功率
- 黑名单命中率
- 认证响应时间

### 2. 业务指标
- 用户活跃度
- 登录频率
- 异常登录检测
- 系统负载

### 3. 安全指标
- 暴力破解尝试
- 异常IP访问
- Token泄露检测
- 安全事件统计
